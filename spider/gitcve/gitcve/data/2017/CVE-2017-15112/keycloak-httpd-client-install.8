.TH keycloak-httpd-client-install 1

.SH NAME
keycloak-httpd-client-install \-
Tools to configure Apache HTTPD as Keycloak client

.SH SYNOPSIS
.B keycloak-httpd-client-install
[\fB\-h\fR]
[\fB\-\-no\-root\-check\fR]
[\fB\-v\fR]
[\fB\-d\fR]
[\fB\-\-show\-traceback\fR]
[\fB\-\-log\-file\fR \fILOG_FILE\fR]
\fB\-\-app\-name\fR \fIAPP_NAME\fR
[\fB\-\-force\fR]
[\fB\-\-permit\-insecure\-transport\fR]
[\fB\-\-tls\-verify\fR]
[\fB\-\-template\-dir\fR \fITEMPLATE_DIR\fR]
[\fB\-\-httpd\-dir\fR \fIHTTPD_DIR\fR] \-r KEYCLOAK_REALM
\fB\-s\fR \fIKEYCLOAK_SERVER_URL\fR
[\fB\-a\fR \fIroot\-admin|realm\-admin|anonymous\fR]
[\fB\-u\fR \fIKEYCLOAK_ADMIN_USERNAME\fR]
\fB\-p\fR \fIKEYCLOAK_ADMIN_PASSWORD\fR
[\fB\-\-keycloak\-admin\-realm\fR \fIKEYCLOAK_ADMIN_REALM\fR]
[\fB\-\-initial\-access\-token\fR \fIINITIAL_ACCESS_TOKEN\fR]
[\fB\-\-client\-originate\-method\fR \fIdescriptor|registration\fR]
[\fB\-\-mellon\-key\-file\fR \fIMELLON_KEY_FILE\fR]
[\fB\-\-mellon\-cert\-file\fR \fIMELLON_CERT_FILE\fR]
[\fB\-\-mellon\-hostname\fR \fIMELLON_HOSTNAME\fR]
[\fB\-\-mellon\-https-port\fR \fIMELLON_HTTPS_PORT\fR]
[\fB\-\-mellon\-root\fR \fIMELLON_ROOT\fR]
[\fB\-\-mellon\-endpoint\fR \fIMELLON_ENDPOINT\fR]
[\fB\-\-mellon\-entity\-id\fR \fIMELLON_ENTITY_ID\fR]
[\fB\-\-mellon\-idp\-attr\-name\fR \fIMELLON_IDP_ATTR_NAME\fR]
[\fB\-\-mellon\-organization\-name\fR \fIMELLON_ORGANIZATION_NAME\fR]
[\fB\-\-mellon\-organization\-display\-name\fR \fIMELLON_ORGANIZATION_DISPLAY_NAME\fR]
[\fB\-\-mellon\-organization\-url\fR \fIMELLON_ORGANIZATION_URL\fR]
[\fB\-l\fR \fIMELLON_PROTECTED_LOCATIONS\fR]

Configure mod_auth_mellon as Keycloak client

.SH OPTIONS
.TP
.BR \-h ", " \-\-help
show this help message and exit
.TP
.BR \-\-no\-root\-check
permit running by non\-root
(default: False)
.TP
.BR \-v ", " \-\-verbose
be chatty
(default: False)
.TP
.BR \-d ", " \-\-debug
turn on debug info
(default: False)
.TP
.BR \-\-show\-traceback
exceptions print traceback in addition to error message
(default: False)
.TP
.BR \-\-log\-file " " \fILOG_FILE\fR
log file pathname
(default: /var/log/python\-keycloak\-httpd\-client/keycloak\-httpd\-client\-install.log)
.TP
.BR \-\-app\-name " " \fIAPP_NAME\fR
name of the web app being protected by mellon
(default: None)
.TP
.BR  \-\-force
forcefully override safety checks
(default: False)
.TP
.BR \-\-permit\-insecure\-transport
Normally secure transport such as TLS is required,
defeat this check
(default: False)
.TP
.BR \-\-tls\-verify
TLS certificate verification for requests to the server. May be one of
case insenstive [true, yes, on] to enable, [false, no, off] to
disable. Or the pathname to a OpenSSL CA bundle to use.
(default: True)

.PP
Program Configuration:

.TP
.BR \-\-template\-dir " " \fITEMPLATE_DIR\fR
Template location
(default: /usr/share/keycloak\-httpd\-client/templates)
.TP
.BR \-\-httpd\-dir " " \fIHTTPD_DIR\fR
Template location
(default: /etc/httpd)

.PP
Keycloak IdP:

.TP
.BR \-r ", " \-\-keycloak\-realm " " \fIKEYCLOAK_REALM\fR
realm name
(default: None)
.TP
.BR \-s ", " \-\-keycloak\-server\-url " " \fIKEYCLOAK_SERVER_URL\fR
Keycloak server URL
(default: None)
.TP
.BR \-a ", " \-\-keycloak\-auth\-role " " \fIroot\-admin|realm\-admin|anonymous\fR
authenticating as what type of user
(default: root\-admin)
.TP
.BR \-u ", " \-\-keycloak\-admin\-username " " \fIKEYCLOAK_ADMIN_USERNAME\fR
admin user name
(default: admin)
.TP
.BR \-p ", " \-\-keycloak\-admin\-password " " \fIKEYCLOAK_ADMIN_PASSWORD\fR
admin password (use - to read from stdin)
(default: None)
.TP
.BR \-\-keycloak\-admin\-realm " " \fIKEYCLOAK_ADMIN_REALM\fR
realm admin belongs to
(default: master)
.TP
.BR \-\-initial\-access\-token " " \fIINITIAL_ACCESS_TOKEN\fR
realm initial access token for client registeration
(default: None)
.TP
.BR \-\-client\-originate\-method " " \fIdescriptor|registration\fR
select Keycloak method for creating SAML client
(default: descriptor)

.PP
Mellon SP:

.TP
.BR \-\-mellon\-key\-file " " \fIMELLON_KEY_FILE\fR
certficate key file
(default: None)
.TP
.BR \-\-mellon\-cert\-file " " \fIMELLON_CERT_FILE\fR
certficate file
(default: None)
.TP
.BR \-\-mellon\-hostname " " \fIMELLON_HOSTNAME\fR
Machine's fully qualified host name
.TP
.BR \-\-mellon\-https\-port " " \fIMELLON_HTTPS_PORT\fR
SSL/TLS port on mellon-hostname
.TP
.BR \-\-mellon\-root " " \fIMELLON_ROOT\fR
Common root ancestor for all mellon endpoints
.TP
.BR \-\-mellon\-endpoint " " \fIMELLON_ENDPOINT\fR
Used to form the MellonEndpointPath, e.g. 
{mellon_root}/{mellon_endpoint}
(default: mellon)
.TP
.BR \-\-mellon\-entity\-id " " \fIMELLON_ENTITY_ID\fR
SP SAML Entity ID
(default: {mellon_http_url}/{mellon_root}/{mellon_endpoint_path}/metadata)
.TP
.BR \-\-mellon\-idp\-attr\-name " " \fIMELLON_IDP_ATTR_NAME\fR
Name of the attribute Mellon adds which will contain the IdP entity id
(default: {mellon_http_url}/{mellon_root}/{mellon_endpoint_path}/metadata)
.TP
.BR \-\-mellon\-organization\-name " " \fIMELLON_ORGANIZATION_NAME\fR
Add SAML OrganizationName to SP metadata
(default: None)
.TP
.BR \-\-mellon\-organization\-display\-name " " \fIMELLON_ORGANIZATION_DISPLAY_NAME\fR
Add SAML OrganizationDisplayName to SP metadata
(default: None)
.TP
.BR \-\-mellon\-organization\-url " " \fIMELLON_ORGANIZATION_URL\fR
Add SAML OrganizationURL to SP metadata
(default: None)
.TP
.BR \-l ", " \-\-mellon\-protected\-locations " " \fIMELLON_PROTECTED_LOCATIONS\fR
Web location to protect with Mellon. May be specified multiple times
(default: [])

.SH DESCRIPTION

\fBkeycloak\-httpd\-client\-install\fR will configure a node running Apache with mod_auth_mellon as SAML Service Provider (\fBSP\fR) utilizing a \fBKeycloak\fR server as an Identity Provider(\fBIdP\fR).

.PP
.B Authentication Levels and Permissions

.PP
The tool is capable of range of configuration steps. But the extent of those operations may be circumscribed by the privilege level (authorization) the tool is run with. The privilege level is determined by the \fB\-\-keycloak\-auth\-role\fR command line option which may be one of:

.PP
\fBroot\-admin\fR: The Keycloak installation has a super realm normally called \fImaster\fR which is the container for all realms hosted by the Keycloak instance. A user with administration priviliges in the \fImaster\fR realm can perform all operations on all realms hosted by the instance. Think of such a user as a root user or root admin.
.PP
\fBrealm\-admin\fR: Each subordinate realm in the Keycloak instance may have it's own administrator(s) whose privileges are restricted exclusively to that realm.
.PP
\fBanonymous\fR: The tool does not authenticate as a user and hence no priviliges are granted. Any privilege is granted by virtue of an \fIinitial access token\fR passed in via the \fB\-initial\-access\-token\fR command line option. Think of an initial access token as a one time password scoped to a specific realm. The initial access token must be generated by an administrator with sufficient priviliges on the realm and given to the user of the tool. The priviliges conferred by the initial access token are limited to registering the client in the realm utilizing the Keycloak client registration service.
.PP
Selecting which authencation role will be used is determined by a combination of the \fB\-\-keycloak\-auth\-role\fR option and the \fB\-\-keycloak\-admin\-realm\fR option. When the authentication role is one of \fIroot\-admin\fR or \fIrealm\-admin\fR the tool will authenticate as a user in a specific realm, the \fB\-\-keycloak\-admin\-realm\fR option declares the realm the administrator will authenticate to. For the \fIroot\-admin\fR role this is typically the \fImaster\fR realm. For the \fIrealm\-admin\fR role this would be realm the tool is registrating the client in.

.PP
.B Determining which authentication role to use

In general the principle of \fIleast privilige\fR should apply. Grant to the tool the least privilige necessary to perform the required action. In oder of least privilige to greatest privilige the following operations are possible under the defined authentication roles:

.PP
.B anonymous
.RS
.PP
\fB*\fR Can register the client using only the Keycloak client registration service. The tool cannot determine a prori if the client already exists in the realm nor can it adjust any configuration options on the client.
.PP
\fB*\fR The realm must pre\-exist.
.RE
.PP
.B realm\-admin
.RS
.PP
\fB*\fR Can enumerate the existing clients in the realm to determine if a conflict would occur.
.PP
\fB*\fR Can delete a pre\-existing client and replace it with the new client definition if the \fB\-\-force\fR option is supplied.
.PP
\fB*\fR Can modify the clients configuration.
.PP
\fB*\fR Can use either the client registration service or the REST API to create the client.
.PP
\fB*\fR The realm must pre\-exist and contain the realm admin user.
.RE
.PP
.B root\-admin
.RS
.PP
\fB*\fR Includes all of the priviliged operation conferred by the \fIrealm\-admin\fR.
.PP
\fB*\fR Can enumerate existing realms on the Keycloak instance to verify the existence of the target realm the client is to be installed in.
.PP
\fB*\fR Can create the target realm if it does not exist.
.RE

.PP
.B Client creation methods

Keycloak offers two methods to add a client to a realm
.PP
.RS
\fB*\fR The OpenID Connect client registration service. Note even though we are registering a SAML Service Provider (SP) which is not part of OAuth2 nor OpenID Connect the client registration service is still capable of registering a SAML SP client. Selected with \fB\-\-client\-originate\-method register\fR.
.PP
\fB*\fR Utilizing the Keycloak REST API to create and configure the SAML SP client. The Keycloak REST API utilizes a 2\-step process whereby the SP metadata is sent to the the Keycloak instance and it returns a client descriptor which is then used to create the client. Selected with \fB\-\-client\-originate\-method descriptor\fR.
.RE
.PP
At the time of this writing the client registration service behaves differently than the REST API. Advice on which to use is likely to be dependent upone the Keycloak version. Note, if anonymous authentication is used in conjunction with a initial access token then the client registration service \fImust\fR be used.
.PP
The client registration service requies the use of an initial access token. For all authentiction roles an initial access token can be provided on the command line via the \fBinitial\-access\-token\fR option. The initial access token will have to have been provided by a Keycloak administrator who pre\-creates it. If the authencation role is either \fIroot\-admin\fR or \fIrealm\-admin\fR the tool has sufficient privilige to obtain an initial access token on it's behalf negating the need for a Keycloak admin to supply one externally.
.PP
The client registration service may be used by the following authentication roles:
.RS
.PP
\fB*\fR root\-admin
.PP
\fB*\fR realm\-admin
.PP
\fB*\fR anonymous (requires use of \fB\-\-initial\-access\-token\fR)
.RE
.PP
The REST API may be used by the following authentication roles:
.RS
.PP
\fB*\fR root\-admin
.PP
\fB*\fR realm\-admin
.RE

.SH OPERATION

.PP
\fBkeycloak\-httpd\-client\-install\fR performs the following operational steps:

.PP
\fB*\fR Connect to Keycloak Server.
.RS
.PP
A session is established with the Keycloak server. OAuth2 is used to log in as the admin user using the \fB\-\-keycloak\-admin\-username\fR and \fB\-\-keycloak\-admin\-password\fR options. The Keycloak server is identified by the \fB\-keycloak\-server\-url\fR option. This step is performed first to assure the remaining steps can complete successfully. A session is maintained for efficiency reasons. You may also need to specify \fB\-\-keycloak\-admin\-role\fR and \fB\-\-keycloak\-admin\-realm\fR to indicate the privilege level you are authenticating with. An anonymous auth role connects to the Keycloak service without any authentication.
.RE

.PP
\fB*\fR Create directories.
.RS
.PP
Files written by \fBkeycloak\-httpd\-client\-install\fR need a destination directory (see \fBFILES\fR). If the necessary directories are not present they are created.
.RE
.PP
\fB*\fR Set up template environment
.RS
.PP
Many of the files written by \fBkeycloak\-httpd\-client\-install\fR are based on \fIjinga2\fR templates. The default template file location can be overridden with the \fB\-\-template\-dir\fR option.
.RE
.PP
\fB*\fR Set up Service Provider X509 Certificiates.
.RS
.PP
A SAML SP must have a X509 certificate and key used to sign and optionally encrypt it's SAML messages sent to the SAML IdP. \fBkeycloak\-httpd\-client\-install\fR can generate a self\-signed certificate for you or you may supply your own key and certificate via the \fB\-\-mellon\-key\-file\fR and \fB\-\-mellon\-cert\-file\fR options. The files must be in PEM format.
.RE
.PP
\fB*\fR Build Mellon httpd config file.
.RS
.PP
The Mellon HTTPD configuration file tells \fImod_auth_mellon\fR where to find things such as certificates and metadata files as well as what web resources to protect. It is generated from the \fImellon_httpd.conf\fR template file. (see \fBFILES\fR). There is one mellon httpd conf file per application.
.RE
.PP
\fB*\fR Build Mellon SP metadata file.
.RS
.PP
The Mellon SP needs to be registered with the Keycloak IdP. This forms a trust relationship and provides infomation to the IdP about the Mellon SP. Registering an SP with an IdP is done via a SP metadata file. The Mellon SP metadata also instructs \fImod_auth_mellon\fR how to operate. The Mellon SP is generated from the \fIsp_metadata.tpl\fR template file.
.RE
.PP
\fB*\fR Query realms from Keycloak server, optionally create new realm.
.RS
.PP
Keycloak supports multi\-tenancy, it may serve many IdP's each one specified by a Keycloak realm. The \fB\-\-keycloak\-realm\fR option identifies which Keycloak realm we will bind to. The Keycloak realm may already exist on the Keycloak server, if it does \fBkeycloak\-httpd\-client\-install\fR will use it. If the Keycloak realm does not exist yet it will be created for you.
.PP
Requires the \fIroot\-admin\fR auth role.
.RE
.PP
\fB*\fR Query realm clients from Keycloak server, optionally delete existing.
.RS
.PP
SAML SP's are one type of Keycloak client that can be serviced by the Keycloak realm IdP. The Mellon SP is a new Keycloak client which needs to be added to the Keycloak realm. However we must assure the new client does not conflict with an existing client on the Keycloak realm. If the Mellon SP is already registered on the Keycloak realm \fBkeycloak\-httpd\-client\-install\fR will stop processing and exit with an error unless the \fB\-\-force\fR option is used. \fB\-\-force\fR will cause the existing client on the Keycloak realm to be deleted first so that it can be replaced in the next step.
.PP
Requires either the \fIroot\-admin\fR or \fIrealm\-admin\fR auth role.
.RE
.PP
\fB*\fR Create new SP client in Keycloak realm.
.RS
.PP
The Mellon SP is registered with the Keycloak realm on the Keycloak server by sending the Keycloak server the Mellon SP metadata to the Keycloak server.
.PP
When the client\-originate\-method is \fIdescriptor\fR either the \fIroot\-admin\fR or \fIrealm\-admin\fR auth role is required. When the \fIclient\-originate\-method\fR is \fIregistration\fR the initial access token is mandatory for the \fIanonymous\fR auth role and optional for the \fIroot\-admin\fR or \fIrealm\-admin\fR roles.
.RE

.PP
\fB*\fR Adjust client configuration
.RS
.PP
Override default Keycloak client values. This varies by Keycloak release.
.PP
Requires either the \fIroot\-admin\fR or \fIrealm\-admin\fR auth role.
.RE

.PP
\fB*\fR Add attributes to be returned in assertion
.RS
.PP
The client is configured to return necessary attributes. The added attributes are:
.RS
.PP
\fB*\fR Groups user is a member of.
.RE
.PP
Requires either the \fIroot\-admin\fR or \fIrealm\-admin\fR auth role.
.RE

.PP
\fB*\fR Retrieve IdP metadata from Keycloak server.
.RS
.PP
The Mellon SP needs SAML metadata that describes the Keycloak IdP. The metadata for the Keycloak IdP is fetched from the Keycloak server and stored in a location referenced in the Mellon SP httpd configuration file. (see \fBFILES\fR)
.RE

.PP
.B STRUCTURE
.PP
The overarching organization is the web application. An independent set of Mellon files are created per application and registered with the Keycloak server. This permits multiple indpendent SAML Service Providers and/or protected web resources to be handled by one Apache instance. When you run \fBkeycloak\-httpd\-client\-install\fR you must supply an application name via the \fB\-\-app\-name\fR option.
.PP
Within the web application you may protect via SAML multiple independent web resources specified via the \fB\-\-mellon\-protected\-locations\fR /xxx option. This will cause a:
.PP
.nf
.RS
<Location>
    AuthType Mellon
    MellonEnable auth
    Require valid-user
</Location>
.RE
.fi

.PP
directive to be added to the Mellon HTTPD configuration file. The Mellon SP parameters are located at the root of the web application root, each protected location inherits from that.

.SH FILES

Files created by running \fBkeycloak\-httpd\-client\-install\fR:
.TP
.B {httpd\-dir}/conf.d/{app\-name}_mellon_keycloak_{realm}.conf
This is the primary Mellon configuration file for the application. It
binds to the Keycloak realm IdP. It is generated from the
\fImellon_httpd.conf\fR template file.

.TP
.B {httpd\-dir}/saml2/{app\-name}.cert
The Mellon SP X509 certficate file in PEM format.

.TP
.B {httpd\-dir}/saml2/{app\-name}.key
The Mellon SP X509 key file in PEM format.

.TP
.B {httpd\-dir}/saml2/{app\-name}_keycloak_{realm}_idp_metadata.xml
The Keycloak SAML2 IdP metadata file. It is fetched from the Keycloak server.

.TP
.B {httpd\-dir}/saml2/{app\-name}_sp_metadata.xml
The Mellon SAML2 SP metadata file. It is generated from the
\fIsp_metadata.xml\fR template file.

.PP
.B Files referenced by \fBkeycloak\-httpd\-client\-install\fR when it runs:

.TP
.B /usr/share/python\-keycloak\-httpd\-client/templates/*
jinja2 templates

.PP
.B Log files:
.TP
.B /var/log/python\-keycloak\-httpd\-client/keycloak\-httpd\-client\-install.log
Installation log file

.PP
.B DEBUGGING
.PP
The \fB\-\-verbose\fR and \fB\-\-debug\fR options can be used to increase the level of detail emitted on the console. However, note the log file logs everything at the \fIDEBUG\fR level so it is usually easier to consult the log file when debugging (see \fBLOGGING\fR)

.PP
.B LOGGING
.PP
\fBkeycloak\-httpd\-client\-install\fR logs all it's operations to a rotated log file. The default log file can be overridden with the \fB\-\-log\-file\fR option. Each run of \fBkeycloak\-httpd\-client\-install\fR will create a new log file. Any previous log file will be rotated as a numbered verson keeping a maximum of 3 previous log files. Logging to the log file occurs at the \fIDEBUG\fR level that includes all HTTP requests and responses, this is useful for debugging.

.PP
.B TEMPLATES
.PP
Many of the files generated by \fBkeycloak\-httpd\-client\-install\fR are produced via jinja2 templates substituting values determined by \fBkeycloak\-httpd\-client\-install\fR when it runs. The default template file location can be overridden with the \fB\-\-template\-dir\fR option.

.PP
.SH EXIT STATUS
.RS
.PP
\fB0\fR: SUCCESS
.PP
\fB1\fR: OPERATION_ERROR
.PP
\fB2\fR: CONFIGURATION_ERROR
.PP
\fB3\fR: INSUFFICIENT_PRIVILEGE
.PP
\fB4\fR: COMMUNICATION_ERROR
.PP
\fB5\fR: ALREADY_EXISTS_ERROR
.RE

.SH AUTHOR
John Dennis <jdennis@redhat.com>
